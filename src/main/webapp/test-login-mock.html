<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM - Login Test (Mock Backend)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/login.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .test-container {
            max-width: 500px;
            width: 100%;
            margin: 2rem;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .test-body {
            padding: 2rem;
        }
        
        .credentials-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-card">
            <div class="test-header">
                <h2><i class="fas fa-graduation-cap me-2"></i>SIM Login Test</h2>
                <p class="mb-0">Mock Backend Testing</p>
            </div>
            
            <div class="test-body">
                <!-- Test Credentials Info -->
                <div class="credentials-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Test Credentials</h6>
                    <div class="row">
                        <div class="col-6">
                            <strong>Admin:</strong><br>
                            Username: admin<br>
                            Password: admin123
                        </div>
                        <div class="col-6">
                            <strong>Teacher:</strong><br>
                            Username: teacher<br>
                            Password: teacher123
                        </div>
                    </div>
                </div>
                
                <!-- Alert Container -->
                <div id="alert-container"></div>
                
                <!-- Login Form -->
                <form id="login-form">
                    <div class="form-floating mb-3">
                        <i class="fas fa-user form-icon"></i>
                        <input type="text" class="form-control" id="identifier" name="identifier" 
                               placeholder="Username" value="admin" required>
                        <label for="identifier">Username</label>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <i class="fas fa-lock form-icon"></i>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Password" value="admin123" required>
                        <label for="password">Password</label>
                        <button type="button" class="password-toggle" id="password-toggle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="remember-me" name="rememberMe">
                        <label class="form-check-label" for="remember-me">Remember me</label>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary login-submit-btn" id="login-btn">
                            <span class="spinner-border spinner-border-sm me-2 d-none login-spinner"></span>
                            <i class="fas fa-sign-in-alt me-2 login-icon"></i>
                            <span class="login-text">Sign In</span>
                        </button>
                    </div>
                </form>
                
                <!-- Status Info -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-server me-1"></i>
                        Backend: <span id="backend-status" class="text-warning">Mock Mode</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Mock backend configuration
        const MOCK_USERS = {
            'admin': {
                id: 1,
                username: 'admin',
                email: 'admin@sim.edu',
                firstName: 'System',
                lastName: 'Administrator',
                userType: 'ADMIN',
                roles: ['ADMIN'],
                permissions: ['ALL_PERMISSIONS'],
                password: 'admin123'
            },
            'teacher': {
                id: 2,
                username: 'teacher',
                email: 'teacher@sim.edu',
                firstName: 'Test',
                lastName: 'Teacher',
                userType: 'TEACHER',
                roles: ['TEACHER'],
                permissions: ['VIEW_STUDENTS', 'MANAGE_GRADES'],
                password: 'teacher123'
            }
        };
        
        // Mock API Service
        class MockAuthService {
            async login(credentials) {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const user = MOCK_USERS[credentials.identifier];
                
                if (!user || user.password !== credentials.password) {
                    throw new Error('Invalid username or password');
                }
                
                // Generate mock JWT token
                const token = this.generateMockToken(user);
                
                return {
                    success: true,
                    data: {
                        accessToken: token,
                        refreshToken: `refresh_${user.id}_${Date.now()}`,
                        tokenType: 'Bearer',
                        expiresIn: 3600,
                        user: {
                            id: user.id,
                            name: `${user.firstName} ${user.lastName}`,
                            email: user.email,
                            username: user.username,
                            userType: user.userType,
                            roles: user.roles,
                            permissions: user.permissions
                        }
                    }
                };
            }
            
            generateMockToken(user) {
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    sub: user.id,
                    username: user.username,
                    email: user.email,
                    roles: user.roles,
                    permissions: user.permissions,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + 3600
                }));
                const signature = btoa(`mock_signature_${user.id}`);
                
                return `${header}.${payload}.${signature}`;
            }
        }
        
        // Initialize mock auth service
        const authService = new MockAuthService();
        
        // DOM elements
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.querySelector('.login-spinner');
        const loginIcon = document.querySelector('.login-icon');
        const loginText = document.querySelector('.login-text');
        const passwordToggle = document.getElementById('password-toggle');
        const passwordField = document.getElementById('password');
        const alertContainer = document.getElementById('alert-container');
        
        // Event listeners
        loginForm.addEventListener('submit', handleLogin);
        passwordToggle.addEventListener('click', togglePassword);
        
        // Handle form submission
        async function handleLogin(e) {
            e.preventDefault();
            
            clearAlerts();
            clearFieldErrors();
            
            const formData = new FormData(loginForm);
            const credentials = {
                identifier: formData.get('identifier').trim(),
                password: formData.get('password'),
                rememberMe: formData.get('rememberMe') === 'on'
            };
            
            if (!credentials.identifier || !credentials.password) {
                showAlert('danger', 'Please enter both username and password');
                return;
            }
            
            setLoadingState(true);
            
            try {
                console.log('Attempting login with:', credentials.identifier);
                
                const result = await authService.login(credentials);
                
                if (result.success) {
                    showAlert('success', 'Login successful!');
                    
                    // Store auth data
                    localStorage.setItem('sim_auth_token', result.data.accessToken);
                    localStorage.setItem('sim_current_user', JSON.stringify(result.data.user));
                    
                    console.log('Login successful:', result.data.user);
                    
                    // Simulate redirect
                    setTimeout(() => {
                        showAlert('info', 'Redirecting to dashboard... (This is a mock test)');
                        
                        // Show user info
                        setTimeout(() => {
                            showUserInfo(result.data.user);
                        }, 2000);
                    }, 1500);
                    
                } else {
                    throw new Error('Login failed');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showAlert('danger', error.message || 'Login failed. Please try again.');
                
            } finally {
                setLoadingState(false);
            }
        }
        
        // Toggle password visibility
        function togglePassword() {
            const icon = passwordToggle.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        // Set loading state
        function setLoadingState(loading) {
            loginBtn.disabled = loading;
            
            if (loading) {
                loginSpinner.classList.remove('d-none');
                loginIcon.classList.add('d-none');
                loginText.textContent = 'Signing In...';
            } else {
                loginSpinner.classList.add('d-none');
                loginIcon.classList.remove('d-none');
                loginText.textContent = 'Sign In';
            }
        }
        
        // Show alert
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
        }
        
        // Clear alerts
        function clearAlerts() {
            alertContainer.innerHTML = '';
        }
        
        // Get alert icon
        function getAlertIcon(type) {
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || icons.info;
        }
        
        // Clear field errors
        function clearFieldErrors() {
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
        }
        
        // Show user info after successful login
        function showUserInfo(user) {
            const userInfoHtml = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-user-check me-2"></i>Login Successful!</h6>
                    <div class="mt-2">
                        <strong>Name:</strong> ${user.name}<br>
                        <strong>Email:</strong> ${user.email}<br>
                        <strong>Role:</strong> ${user.userType}<br>
                        <strong>Permissions:</strong> ${user.permissions.join(', ')}
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-success" onclick="testDashboard()">
                            <i class="fas fa-tachometer-alt me-1"></i>Test Dashboard
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </div>
                </div>
            `;
            alertContainer.innerHTML = userInfoHtml;
        }
        
        // Test dashboard function
        function testDashboard() {
            showAlert('info', 'Dashboard test: Authentication working! Ready for backend integration.');
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('sim_auth_token');
            localStorage.removeItem('sim_current_user');
            clearAlerts();
            showAlert('info', 'Logged out successfully');
            
            // Reset form
            document.getElementById('identifier').value = 'admin';
            document.getElementById('password').value = 'admin123';
        }
        
        // Check if already logged in
        const existingToken = localStorage.getItem('sim_auth_token');
        const existingUser = localStorage.getItem('sim_current_user');
        
        if (existingToken && existingUser) {
            try {
                const user = JSON.parse(existingUser);
                showAlert('info', 'Already logged in. Showing user info...');
                setTimeout(() => showUserInfo(user), 1000);
            } catch (e) {
                localStorage.removeItem('sim_auth_token');
                localStorage.removeItem('sim_current_user');
            }
        }
        
        console.log('Mock login test page loaded');
        console.log('Available test users:', Object.keys(MOCK_USERS));
    </script>
</body>
</html>