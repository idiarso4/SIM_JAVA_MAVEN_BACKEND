<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM - Auth Test (Simple)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/login.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .test-body {
            padding: 2rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .credentials-card {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-card">
            <div class="test-header">
                <h2><i class="fas fa-graduation-cap me-2"></i>SIM Auth Test</h2>
                <p class="mb-0">Authentication System Testing</p>
            </div>
            
            <div class="test-body">
                <!-- Status Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>System Status</h5>
                        <div class="mb-2">
                            <span class="status-indicator status-info" id="frontend-status"></span>
                            <span>Frontend: <span id="frontend-status-text">Loading...</span></span>
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-warning" id="backend-status"></span>
                            <span>Backend: <span id="backend-status-text">Checking...</span></span>
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-info" id="auth-status"></span>
                            <span>Auth Service: <span id="auth-status-text">Initializing...</span></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Test Credentials</h5>
                        <div class="credentials-card">
                            <strong>Admin User:</strong><br>
                            Email: admin@school.com<br>
                            Password: admin123<br><br>
                            <strong>Teacher User:</strong><br>
                            Email: teacher@school.com<br>
                            Password: teacher123
                        </div>
                    </div>
                </div>
                
                <!-- Login Form Section -->
                <div class="row">
                    <div class="col-md-6">
                        <h5>Login Test</h5>
                        <form id="test-login-form">
                            <div class="mb-3">
                                <label for="test-identifier" class="form-label">Email/Username</label>
                                <input type="text" class="form-control" id="test-identifier" 
                                       value="admin@school.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="test-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="test-password" 
                                       value="admin123" required>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="test-remember">
                                <label class="form-check-label" for="test-remember">Remember me</label>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="test-login-btn">
                                    <span class="spinner-border spinner-border-sm me-2 d-none" id="test-spinner"></span>
                                    <i class="fas fa-sign-in-alt me-2"></i>Test Login
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="test-logout-btn" disabled>
                                    <i class="fas fa-sign-out-alt me-2"></i>Test Logout
                                </button>
                            </div>
                        </form>
                        
                        <!-- Current User Info -->
                        <div id="user-info" class="mt-3 d-none">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-user me-2"></i>Logged in as:</h6>
                                <div id="user-details"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Activity Log</h5>
                        <div class="log-container" id="log-container">
                            <div class="log-entry">
                                <span class="log-timestamp">[Loading...]</span> Initializing test environment...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-log-btn">
                                <i class="fas fa-trash me-1"></i>Clear Log
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Mock backend for testing
        const MOCK_BACKEND = true;
        
        // Configuration
        window.APP_CONFIG = {
            API_BASE_URL: MOCK_BACKEND ? 'http://localhost:3000/mock-api' : 'http://localhost:8080/api/v1',
            TOKEN_KEY: 'sim_auth_token',
            REFRESH_TOKEN_KEY: 'sim_refresh_token',
            USER_KEY: 'sim_current_user'
        };
        
        // Mock users database
        const MOCK_USERS = {
            'admin@school.com': {
                id: 1,
                name: 'Administrator',
                email: 'admin@school.com',
                userType: 'ADMIN',
                roles: ['ADMIN', 'SUPER_ADMIN'],
                permissions: ['ALL_PERMISSIONS'],
                password: 'admin123'
            },
            'teacher@school.com': {
                id: 2,
                name: 'John Teacher',
                email: 'teacher@school.com',
                nip: '123456789',
                userType: 'TEACHER',
                roles: ['TEACHER'],
                permissions: ['VIEW_STUDENTS', 'EDIT_GRADES'],
                password: 'teacher123'
            }
        };
        
        // Simple logger
        window.logger = {
            debug: (msg, ...args) => addLog('DEBUG', msg, args),
            info: (msg, ...args) => addLog('INFO', msg, args),
            warn: (msg, ...args) => addLog('WARN', msg, args),
            error: (msg, ...args) => addLog('ERROR', msg, args)
        };
        
        // Simple state manager
        window.stateManager = {
            state: {},
            set: function(key, value) {
                this.state[key] = value;
                logger.debug(`State set: ${key}`, value);
            },
            get: function(key) {
                return this.state[key];
            },
            subscribe: function(key, callback) {
                return () => {};
            }
        };
        
        // Mock API Service
        class MockApiService {
            async post(endpoint, data) {
                logger.info(`API Call: POST ${endpoint}`, data);
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (endpoint === '/auth/login') {
                    return this.handleLogin(data);
                } else if (endpoint === '/auth/logout') {
                    return this.handleLogout();
                } else if (endpoint === '/auth/refresh') {
                    return this.handleRefresh(data);
                }
                
                throw new Error(`Mock endpoint not implemented: ${endpoint}`);
            }
            
            async get(endpoint, options = {}) {
                logger.info(`API Call: GET ${endpoint}`);
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (endpoint === '/auth/validate') {
                    return this.handleValidate(options);
                } else if (endpoint === '/auth/me') {
                    return this.handleGetCurrentUser(options);
                }
                
                throw new Error(`Mock endpoint not implemented: ${endpoint}`);
            }
            
            handleLogin(data) {
                const { identifier, password, rememberMe } = data;
                const user = MOCK_USERS[identifier];
                
                if (!user || user.password !== password) {
                    const error = new Error('Invalid email/username or password');
                    error.status = 401;
                    throw error;
                }
                
                // Generate mock JWT token
                const token = this.generateMockToken(user);
                const refreshToken = this.generateMockRefreshToken(user);
                
                return {
                    data: {
                        accessToken: token,
                        refreshToken: refreshToken,
                        tokenType: 'Bearer',
                        expiresIn: 3600,
                        user: {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            nip: user.nip,
                            userType: user.userType,
                            roles: user.roles,
                            permissions: user.permissions
                        }
                    }
                };
            }
            
            handleLogout() {
                return {
                    data: {
                        message: 'Logout successful',
                        timestamp: Date.now()
                    }
                };
            }
            
            handleRefresh(data) {
                // Simple refresh token validation
                if (!data.refreshToken || !data.refreshToken.startsWith('refresh_')) {
                    const error = new Error('Invalid refresh token');
                    error.status = 401;
                    throw error;
                }
                
                // Extract user from refresh token (mock)
                const userId = data.refreshToken.split('_')[1];
                const user = Object.values(MOCK_USERS).find(u => u.id == userId);
                
                if (!user) {
                    const error = new Error('Invalid refresh token');
                    error.status = 401;
                    throw error;
                }
                
                const token = this.generateMockToken(user);
                const refreshToken = this.generateMockRefreshToken(user);
                
                return {
                    data: {
                        accessToken: token,
                        refreshToken: refreshToken,
                        tokenType: 'Bearer',
                        expiresIn: 3600
                    }
                };
            }
            
            handleValidate(options) {
                const authHeader = options.headers?.Authorization;
                if (!authHeader || !authHeader.startsWith('Bearer ')) {
                    const error = new Error('Invalid token');
                    error.status = 401;
                    throw error;
                }
                
                return {
                    data: {
                        valid: true,
                        userInfo: { message: 'Token is valid' }
                    }
                };
            }
            
            handleGetCurrentUser(options) {
                const authHeader = options.headers?.Authorization;
                if (!authHeader || !authHeader.startsWith('Bearer ')) {
                    const error = new Error('Invalid token');
                    error.status = 401;
                    throw error;
                }
                
                // Extract user from token (mock)
                const token = authHeader.substring(7);
                const userId = token.split('_')[1];
                const user = Object.values(MOCK_USERS).find(u => u.id == userId);
                
                if (!user) {
                    const error = new Error('User not found');
                    error.status = 404;
                    throw error;
                }
                
                return {
                    data: {
                        user: {
                            id: user.id,
                            name: user.name,
                            email: user.email,
                            nip: user.nip,
                            userType: user.userType,
                            roles: user.roles,
                            permissions: user.permissions
                        }
                    }
                };
            }
            
            generateMockToken(user) {
                // Simple mock JWT token
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    sub: user.id,
                    email: user.email,
                    name: user.name,
                    roles: user.roles,
                    permissions: user.permissions,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + 3600 // 1 hour
                }));
                const signature = btoa(`mock_signature_${user.id}`);
                
                return `${header}.${payload}.${signature}`;
            }
            
            generateMockRefreshToken(user) {
                return `refresh_${user.id}_${Date.now()}`;
            }
        }
        
        // Initialize services
        const apiService = MOCK_BACKEND ? new MockApiService() : null;
        
        // Import and initialize auth service
        let authService;
        
        try {
            // Try to import the real auth service
            const { AuthService } = await import('./js/services/auth.js');
            
            // Override API service if using mock
            if (MOCK_BACKEND) {
                authService = new AuthService();
                authService.apiService = apiService;
            } else {
                authService = new AuthService();
            }
            
            updateStatus('auth-status', 'success', 'Ready');
            logger.info('Auth service initialized successfully');
            
        } catch (error) {
            logger.error('Failed to initialize auth service:', error);
            updateStatus('auth-status', 'error', 'Failed');
        }
        
        // DOM elements
        const loginForm = document.getElementById('test-login-form');
        const loginBtn = document.getElementById('test-login-btn');
        const logoutBtn = document.getElementById('test-logout-btn');
        const spinner = document.getElementById('test-spinner');
        const userInfo = document.getElementById('user-info');
        const userDetails = document.getElementById('user-details');
        const clearLogBtn = document.getElementById('clear-log-btn');
        
        // Event listeners
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        clearLogBtn.addEventListener('click', clearLog);
        
        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('test-identifier').value;
            const password = document.getElementById('test-password').value;
            const rememberMe = document.getElementById('test-remember').checked;
            
            setLoadingState(true);
            
            try {
                logger.info('Attempting login...', { identifier, rememberMe });
                
                const result = await authService.login({
                    identifier,
                    password,
                    rememberMe
                });
                
                if (result.success) {
                    logger.info('Login successful!', result.user);
                    showUserInfo(result.user);
                    updateLoginState(true);
                } else {
                    throw new Error(result.message || 'Login failed');
                }
                
            } catch (error) {
                logger.error('Login failed:', error.message);
                hideUserInfo();
                updateLoginState(false);
            } finally {
                setLoadingState(false);
            }
        }
        
        // Handle logout
        async function handleLogout() {
            try {
                logger.info('Attempting logout...');
                await authService.logout();
                logger.info('Logout successful');
                hideUserInfo();
                updateLoginState(false);
            } catch (error) {
                logger.error('Logout failed:', error.message);
            }
        }
        
        // UI helper functions
        function setLoadingState(loading) {
            loginBtn.disabled = loading;
            if (loading) {
                spinner.classList.remove('d-none');
                loginBtn.querySelector('span:last-child').textContent = 'Logging in...';
            } else {
                spinner.classList.add('d-none');
                loginBtn.querySelector('span:last-child').textContent = 'Test Login';
            }
        }
        
        function updateLoginState(isLoggedIn) {
            loginBtn.disabled = isLoggedIn;
            logoutBtn.disabled = !isLoggedIn;
        }
        
        function showUserInfo(user) {
            userDetails.innerHTML = `
                <strong>Name:</strong> ${user.name}<br>
                <strong>Email:</strong> ${user.email}<br>
                ${user.nip ? `<strong>NIP:</strong> ${user.nip}<br>` : ''}
                <strong>Type:</strong> ${user.userType}<br>
                <strong>Roles:</strong> ${user.roles?.join(', ') || 'None'}<br>
                <strong>Permissions:</strong> ${user.permissions?.length || 0} permissions
            `;
            userInfo.classList.remove('d-none');
        }
        
        function hideUserInfo() {
            userInfo.classList.add('d-none');
        }
        
        function updateStatus(elementId, status, text) {
            const indicator = document.getElementById(elementId);
            const textElement = document.getElementById(elementId + '-text');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }
        
        function addLog(level, message, args = []) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const argsStr = args.length > 0 ? ' ' + JSON.stringify(args) : '';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span> 
                <strong>${level}:</strong> ${message}${argsStr}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
            logger.info('Log cleared');
        }
        
        // Initialize
        async function initialize() {
            logger.info('Initializing test environment...');
            
            // Update status indicators
            updateStatus('frontend-status', 'success', 'Ready');
            
            if (MOCK_BACKEND) {
                updateStatus('backend-status', 'info', 'Mock Mode');
                logger.info('Using mock backend for testing');
            } else {
                // Test real backend connection
                try {
                    const response = await fetch(window.APP_CONFIG.API_BASE_URL + '/auth/status');
                    if (response.ok) {
                        updateStatus('backend-status', 'success', 'Connected');
                        logger.info('Backend connection successful');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    updateStatus('backend-status', 'error', 'Disconnected');
                    logger.error('Backend connection failed:', error.message);
                }
            }
            
            // Check if already logged in
            if (authService && authService.isAuthenticated()) {
                const user = authService.getCurrentUser();
                if (user) {
                    showUserInfo(user);
                    updateLoginState(true);
                    logger.info('Already logged in as:', user.name);
                }
            }
            
            logger.info('Test environment ready');
        }
        
        // Start initialization
        initialize();
    </script>
</body>
</html>