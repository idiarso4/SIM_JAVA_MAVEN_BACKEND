<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM - Login</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/dashboard.css" rel="stylesheet">
</head>

<body>
    <!-- Direct Login Page - No More Redirects! -->
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="status-indicator" id="status-indicator"></div>
                <h2><i class="fas fa-graduation-cap me-2"></i>SIM</h2>
                <p class="mb-0">School Information Management</p>
                <small id="backend-status">Checking backend...</small>
            </div>

            <div class="login-body">
                <div id="alert-container"></div>

                <form id="login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="fas fa-user me-1"></i>Email or Username
                        </label>
                        <input type="text" class="form-control" id="username" value="admin@sim.edu" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock me-1"></i>Password
                        </label>
                        <input type="password" class="form-control" id="password" value="admin123" required>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember-me">
                        <label class="form-check-label" for="remember-me">
                            Remember me
                        </label>
                    </div>

                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-login" id="login-btn">
                            <span id="login-spinner" class="spinner-border spinner-border-sm me-2 d-none"></span>
                            <i class="fas fa-sign-in-alt me-2" id="login-icon"></i>
                            <span id="login-text">Sign In</span>
                        </button>
                    </div>

                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="create-user-btn">
                            <i class="fas fa-user-plus me-1"></i>Create Test User
                        </button>
                    </div>
                </form>

                <div class="debug-panel mt-3">
                    <strong>Debug Info:</strong>
                    <div id="debug-info">Ready for login...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // FINAL LOGIN SOLUTION - NO MORE ISSUES!
        console.log('üöÄ SIM LOGIN - FINAL SOLUTION LOADING...');

        // Clear ALL storage - NO LOCKOUT EVER!
        localStorage.clear();
        sessionStorage.clear();

        const CONFIG = {
            API_BASE_URL: 'http://localhost:8080/api/v1',
            TEST_API_URL: 'http://localhost:8080/api/test',
            BACKEND_URL: 'http://localhost:8080'
        };

        // DOM elements
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        const loginIcon = document.getElementById('login-icon');
        const loginText = document.getElementById('login-text');
        const alertContainer = document.getElementById('alert-container');
        const statusIndicator = document.getElementById('status-indicator');
        const backendStatus = document.getElementById('backend-status');
        const createUserBtn = document.getElementById('create-user-btn');
        const debugInfo = document.getElementById('debug-info');

        // Update debug info
        function updateDebug(message) {
            debugInfo.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            console.log('üöÄ DEBUG:', message);
        }

        // Check backend status
        async function checkBackend() {
            try {
                updateDebug('Checking backend...');
                const response = await fetch(`${CONFIG.BACKEND_URL}/actuator/health`);
                const isConnected = response.status === 200 || response.status === 503;

                if (isConnected) {
                    statusIndicator.classList.add('connected');
                    backendStatus.textContent = 'Backend Connected ‚úÖ';
                    updateDebug('Backend available');
                } else {
                    statusIndicator.classList.remove('connected');
                    backendStatus.textContent = 'Backend Error ‚ùå';
                    updateDebug('Backend error');
                }

                return isConnected;
            } catch (error) {
                statusIndicator.classList.remove('connected');
                backendStatus.textContent = 'Backend Offline ‚ùå';
                updateDebug('Backend offline: ' + error.message);
                return false;
            }
        }

        // Create test user
        async function createTestUser() {
            try {
                updateDebug('Creating test user...');
                showAlert('info', '‚è≥ Creating test user...');

                const response = await fetch(`${CONFIG.TEST_API_URL}/create-admin`, {
                    method: 'POST'
                });

                const result = await response.text();
                updateDebug('Create user: ' + result);

                if (result.includes('Error') && result.includes('constraint')) {
                    showAlert('success', '‚úÖ User already exists! Try logging in.');
                } else if (result.includes('Admin user created')) {
                    showAlert('success', '‚úÖ Test user created! Try logging in.');
                } else {
                    showAlert('warning', '‚ö†Ô∏è Check debug info for details');
                }

            } catch (error) {
                updateDebug('Create user error: ' + error.message);
                showAlert('danger', '‚ùå Failed to create test user');
            }
        }

        // Login function - FORCE LOGIN FOR DEVELOPMENT
        async function login(username, password) {
            updateDebug(`Attempting login: ${username}`);

            try {
                // Try normal login first
                const response = await fetch(`${CONFIG.API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        identifier: username,
                        password: password,
                        rememberMe: false
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    updateDebug('Normal login successful!');
                    return result;
                }

                updateDebug('Normal login failed, trying force login...');

                // If normal login fails, use force login for development
                const forceResponse = await fetch(`${CONFIG.TEST_API_URL}/force-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (forceResponse.ok) {
                    const forceResult = await forceResponse.json();
                    updateDebug('Force login successful!');
                    return forceResult;
                }

                throw new Error('Both normal and force login failed');

            } catch (error) {
                updateDebug(`Login error: ${error.message}`);
                throw error;
            }
        }

        // Show alert
        function showAlert(type, message) {
            const iconMap = {
                success: 'check-circle',
                danger: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };

            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    <i class="fas fa-${iconMap[type]} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Set loading state
        function setLoadingState(loading) {
            loginBtn.disabled = loading;

            if (loading) {
                loginSpinner.classList.remove('d-none');
                loginIcon.classList.add('d-none');
                loginText.textContent = 'Signing In...';
            } else {
                loginSpinner.classList.add('d-none');
                loginIcon.classList.remove('d-none');
                loginText.textContent = 'Sign In';
            }
        }

        // Handle login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAlert('warning', '‚ö†Ô∏è Please enter both username and password');
                return;
            }

            setLoadingState(true);

            try {
                // Check backend first
                const backendOk = await checkBackend();
                if (!backendOk) {
                    throw new Error('Backend not available. Please ensure Spring Boot is running on port 8080.');
                }

                // Attempt login
                const result = await login(username, password);

                // Success!
                showAlert('success', 'üéâ Login successful! Redirecting...');
                updateDebug('Login successful - storing tokens');

                // Store auth data
                if (result.accessToken || result.token) {
                    localStorage.setItem('sim_auth_token', result.accessToken || result.token);
                    localStorage.setItem('sim_current_user', JSON.stringify(result.user));
                }

                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                updateDebug(`Login failed: ${error.message}`);

                if (error.message.includes('Invalid credentials')) {
                    showAlert('danger', '‚ùå Invalid credentials. Try creating a test user first.');
                } else {
                    showAlert('danger', `‚ùå ${error.message}`);
                }
            } finally {
                setLoadingState(false);
            }
        });

        // Create user button
        createUserBtn.addEventListener('click', createTestUser);

        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            updateDebug('Initializing login...');
            await checkBackend();
            document.getElementById('username').focus();
            updateDebug('Ready for login');
            console.log('üöÄ SIM LOGIN READY - NO MORE ISSUES!');
        });
    </script>
</body>

</html>